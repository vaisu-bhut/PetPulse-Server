name: Build and Publish

on:
  push:
    branches: ["main", "preview"]

jobs:
  build-and-push:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest
    if: github.repository_owner == 'Clestiq-PetPulse'

    permissions:
      contents: "read"
      id-token: "write"

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - id: "auth"
        name: "Authenticate to Google Cloud"
        uses: "google-github-actions/auth@v2"
        with:
          credentials_json: "${{ secrets.GCP_CREDENTIALS }}"

      - name: "Set up Cloud SDK"
        uses: "google-github-actions/setup-gcloud@v2"

      - name: "Determine Environment Variables"
        id: env-vars
        run: |
          if [[ "${{ github.ref_name }}" == "main" ]]; then
            echo "REPO_NAME=petpulse-production" >> $GITHUB_OUTPUT
            echo "ENV_NAME=production" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref_name }}" == "preview" ]]; then
            echo "REPO_NAME=petpulse-preview" >> $GITHUB_OUTPUT
            echo "ENV_NAME=preview" >> $GITHUB_OUTPUT
          fi

      - name: "Create Artifact Registry Repository"
        run: |
          REPO="${{ steps.env-vars.outputs.REPO_NAME }}"
          if ! gcloud artifacts repositories describe $REPO --location=${{ vars.REGION }} > /dev/null 2>&1; then
            echo "Repository $REPO does not exist. Creating..."
            gcloud artifacts repositories create $REPO \
              --repository-format=docker \
              --location=${{ vars.REGION }} \
              --description="Docker repository for PetPulse ${{ steps.env-vars.outputs.ENV_NAME }}"
          else
            echo "Repository $REPO already exists."
          fi

      - name: "Configure Docker for Artifact Registry"
        run: |
          gcloud auth configure-docker ${{ vars.REGION }}-docker.pkg.dev

      - name: Extract Metadata (Server)
        id: meta-server
        run: |
          REPO="${{ steps.env-vars.outputs.REPO_NAME }}"
          BASE_IMAGE="${{ vars.REGION }}-docker.pkg.dev/${{ vars.PROJECT_ID }}/$REPO/petpulse-server"
          echo "TAGS=${BASE_IMAGE}:latest" >> $GITHUB_OUTPUT

      - name: Extract Metadata (Worker)
        id: meta-worker
        run: |
          REPO="${{ steps.env-vars.outputs.REPO_NAME }}"
          BASE_IMAGE="${{ vars.REGION }}-docker.pkg.dev/${{ vars.PROJECT_ID }}/$REPO/petpulse-worker"
          echo "TAGS=${BASE_IMAGE}:latest" >> $GITHUB_OUTPUT

      - name: Extract Metadata (Agent)
        id: meta-agent
        run: |
          REPO="${{ steps.env-vars.outputs.REPO_NAME }}"
          BASE_IMAGE="${{ vars.REGION }}-docker.pkg.dev/${{ vars.PROJECT_ID }}/$REPO/petpulse-agent"
          echo "TAGS=${BASE_IMAGE}:latest" >> $GITHUB_OUTPUT

      - name: Build and Push Server
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile.server
          push: true
          tags: ${{ steps.meta-server.outputs.TAGS }}

      - name: Build and Push Worker
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile.worker
          push: true
          tags: ${{ steps.meta-worker.outputs.TAGS }}

      - name: Build and Push Agent
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile.agent
          push: true
          tags: ${{ steps.meta-agent.outputs.TAGS }}
